<!doctype html>
<html lang="hi" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF Compressor ‚Äî Office Tools (Enhanced)</title>
  <meta name="description" content="Advanced PDF file compression with multiple algorithms. Reduce PDF size by up to 80% with proper compression techniques. All processing in browser - secure and private.">
  <meta name="keywords" content="PDF compressor, compress PDF, reduce PDF size, PDF optimizer, ‡§π‡§ø‡§Ç‡§¶‡•Ä PDF compressor, PDF ‡§∏‡§æ‡§á‡§ú‡§º ‡§ï‡§Æ ‡§ï‡§∞‡•á‡§Ç">
  <meta name="robots" content="index, follow">
  
  <style>
    :root{
      --accent:#0b84ff;
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111111;
      --muted:#566173;
      --border:#e5e7eb;
      --shadow:0 8px 24px rgba(10,20,40,.08);
      --menu-bg:#ffffff;
      --success:#22c55e;
      --warning:#f59e0b;
      --error:#ef4444;
    }
    [data-theme="dark"]{
      --bg:#0b0f15;
      --card:#0e141c;
      --text:#f1f5f9;
      --muted:#cbd5e1;
      --border:#1f2a37;
      --shadow:0 18px 40px rgba(0,0,0,.55);
      --menu-bg:#101823;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:1000;background:var(--card);box-shadow:var(--shadow)}
    .nav{display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto;padding:.7rem 1rem;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-badge{width:36px;height:36px;border-radius:9px;background:var(--accent);display:grid;place-items:center;color:#fff;font-weight:800}
    .brand-name{font-weight:800;font-size:1.05rem}
    .menu{display:flex;gap:10px;align-items:center}
    .menu > li{list-style:none;position:relative}
    .menu > li > a{padding:.55rem .8rem;border-radius:8px;display:flex;align-items:center;gap:6px}
    .menu > li:hover > a{background:rgba(11,132,255,.08)}
    .submenu {
  display: none;
  position: absolute;
  top: 100%;   /* removed gap */
  left: 0;
  background: var(--menu-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: var(--shadow);
  min-width: 220px;
  max-height: 60vh;
  overflow: auto;
  z-index: 1001; /* make sure it stays on top */
}

.submenu a {
  display: block;
  padding: .6rem .9rem;
  border-bottom: 1px solid rgba(0,0,0,.04);
}
.submenu a:last-child {
  border-bottom: none;
}

/* Keep submenu visible if hovering inside it */
.menu > li:hover .submenu,
.menu > li .submenu:hover {
  display: block;
}

    .spacer{flex:1}
    .toggle{border:1px solid var(--border);background:transparent;color:var(--text);padding:.45rem .8rem;border-radius:8px;cursor:pointer}
    main{max-width:1200px;margin:1.5rem auto;padding:0 1rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:24px;margin-bottom:1.5rem}
    .drop{border:2px dashed var(--border);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:.15s;background:transparent}
    .drop.drag{background:rgba(11,132,255,.07);border-color:var(--accent)}
    .drop:hover{background:rgba(11,132,255,.03)}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin:20px 0}
    .control{display:flex;flex-direction:column;gap:6px}
    .control-group{display:flex;gap:12px;align-items:flex-end;grid-column:1/-1}
    label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:6px;font-weight:500}
    input,select{width:100%;padding:.6rem;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text)}
    input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(11,132,255,.1)}
    .primary{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:.65rem 1.2rem;cursor:pointer;font-weight:500;transition:.2s}
    .primary:hover{background:#0066cc}
    .primary:disabled{background:var(--muted);cursor:not-allowed}
    .secondary{background:transparent;color:var(--accent);border:1px solid var(--accent);border-radius:8px;padding:.6rem 1.2rem;cursor:pointer;font-weight:500;transition:.2s}
    .secondary:hover{background:rgba(11,132,255,.08)}
    .results{display:flex;flex-direction:column;gap:18px;margin-top:16px}
    .file-item{display:grid;grid-template-columns:1fr auto;gap:20px;padding:20px;border:1px solid var(--border);border-radius:12px;align-items:center}
    .file-info h4{margin:0 0 6px;font-size:1rem}
    .file-meta{font-size:.85rem;color:var(--muted);margin:4px 0}
    .compression-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin:8px 0;font-size:.8rem}
    .stat{text-align:center;padding:6px;border-radius:6px;background:rgba(11,132,255,.05)}
    .file-actions{display:flex;flex-direction:column;gap:8px;align-items:center;min-width:120px}
    .progress{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;display:none}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status{padding:.4rem .8rem;border-radius:6px;font-size:.8rem;font-weight:500;text-align:center;width:100%}
    .status.success{background:rgba(34,197,94,.1);color:#059669}
    .status.error{background:rgba(239,68,68,.1);color:#dc2626}
    .status.processing{background:rgba(245,158,11,.1);color:#d97706}
    .download{display:none;background:var(--success);color:#fff;padding:.5rem .8rem;border-radius:6px;text-decoration:none;font-size:.85rem;font-weight:500;text-align:center}
    .download:hover{background:#16a34a}
    .warning-box{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:16px;margin:16px 0;color:#d97706}
    .info-box{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);border-radius:8px;padding:16px;margin:16px 0;color:#2563eb}
    .algorithm-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:16px 0;font-size:.9rem}
    .algorithm{padding:12px;border:1px solid var(--border);border-radius:8px;text-align:center}
    .algorithm strong{display:block;margin-bottom:4px;color:var(--accent)}
    footer{padding:20px;text-align:center;color:var(--muted);border-top:1px solid var(--border)}
    
    @media (max-width: 768px) {
      .menu{display:none}
      .controls{grid-template-columns:1fr}
      .file-item{grid-template-columns:1fr;text-align:center}
      .algorithm-info{grid-template-columns:1fr}
      .compression-stats{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand">
        <div class="brand-badge">OT</div>
        <div class="brand-name">Office Tools</div>
      </div>
      <ul class="menu">
        <li><a href="index.html">Home</a></li>
        <li>
          <a href="#">PDF Tools ‚ñæ</a>
          <div class="submenu">
            <a href="#">PDF Compressor</a>
            <a href="pdf-editor.html">PDF Editor</a>
            <a href="#">PDF to Word</a>
          </div>
        </li>
        <li>
          <a href="#">Excel Tools ‚ñæ</a>
          <div class="submenu">
            <a href="#">Excel to PDF</a>
            <a href="#">XLS to XLSX</a>
          </div>
        </li>
        <li>
          <a href="#">Image Tools ‚ñæ</a>
          <div class="submenu">
            <a href="img-compress.html">Image Compressor</a>
          </div>
        </li>
      </ul>
      <div class="spacer"></div>
      <button id="modeToggle" class="toggle" type="button">üåô Dark</button>
    </nav>
  </header>

  <main>
    <div class="card">
      <h1 style="margin:0 0 8px 0">Advanced PDF Compressor</h1>
      <p style="color:var(--muted);margin:0 0 1rem">Multiple compression algorithms for maximum PDF size reduction. ‡§∏‡§≠‡•Ä ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§π‡•Ä ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡§Ç - 100% ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§‡•§</p>

      <div class="info-box">
        <strong>‡§®‡§à ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§è‡§Ç:</strong> Advanced compression algorithms, Image recompression, Object stream optimization, ‡§î‡§∞ Flate compression ‡§∏‡•á ‡§¨‡•á‡§π‡§§‡§∞ results‡•§
      </div>

      <div id="drop" class="drop" tabindex="0">
        <div style="font-size:2rem;margin-bottom:12px">üìÑ</div>
        <strong style="font-size:1.1rem">PDF ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§Ø‡§π‡§æ‡§Å ‡§°‡•ç‡§∞‡•à‡§ó ‡§ï‡§∞‡•á‡§Ç</strong>
        <div style="margin:12px 0">‡§Ø‡§æ <button id="browseBtn" class="primary" type="button">‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç</button></div>
        <div style="font-size:.9rem;color:var(--muted)">Multiple files supported ‚Ä¢ Maximum 100MB per file</div>
        <input id="fileInput" type="file" accept=".pdf,application/pdf" multiple hidden>
      </div>

      <div class="warning-box">
        <strong>‚ö†Ô∏è ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä:</strong> ‡§Ø‡§¶‡§ø PDF ‡§Æ‡•á‡§Ç ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä images compressed ‡§π‡•à‡§Ç ‡§Ø‡§æ text-only content ‡§π‡•à, ‡§§‡•ã compression limited ‡§π‡•ã‡§ó‡•Ä‡•§ Best results image-heavy ‡§î‡§∞ unoptimized PDFs ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ø‡§≤‡§§‡•á ‡§π‡•à‡§Ç‡•§
      </div>

      <div class="controls">
        <div class="control">
          <label for="compressionLevel">Compression Level</label>
          <select id="compressionLevel">
            <option value="light">Light (‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§¨‡§®‡•Ä ‡§∞‡§π‡•á‡§ó‡•Ä)</option>
            <option value="medium" selected>Medium (‡§∏‡§Ç‡§§‡•Å‡§≤‡§ø‡§§)</option>
            <option value="strong">Strong (‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ‡§á‡§ú‡§º)</option>
            <option value="maximum">Maximum (‡§∏‡§¨‡§∏‡•á ‡§õ‡•ã‡§ü‡§æ)</option>
          </select>
        </div>
        <div class="control">
          <label for="imageQuality">Image Quality: <span id="imgQVal">70</span>%</label>
          <input id="imageQuality" type="range" min="20" max="95" value="70">
        </div>
        <div class="control">
          <label for="targetSizeMB">Target Size (MB, optional)</label>
          <input id="targetSizeMB" type="number" placeholder="Auto" min="0.1" max="100" step="0.1">
        </div>
        <div class="control">
          <label for="removeMetadata">
            <input type="checkbox" id="removeMetadata" checked style="width:auto;margin-right:8px">
            Remove Metadata & Unused Objects
          </label>
        </div>
        <div class="control-group">
          <button id="analyzeBtn" class="secondary" type="button" disabled>Analyze PDFs</button>
          <button id="compressBtn" class="primary" type="button" disabled>
            üóúÔ∏è Compress All
          </button>
          <button id="clearBtn" class="secondary" type="button" disabled">Clear All</button>
        </div>
      </div>

      <div class="algorithm-info">
        <div class="algorithm">
          <strong>Flate Compression</strong>
          <div>PDF streams ‡§ï‡•Ä lossless compression</div>
        </div>
        <div class="algorithm">
          <strong>Image Recompression</strong>
          <div>Embedded images ‡§ï‡•ã JPEG compress ‡§ï‡§∞‡§®‡§æ</div>
        </div>
        <div class="algorithm">
          <strong>Object Optimization</strong>
          <div>Unused objects ‡§î‡§∞ duplicates remove ‡§ï‡§∞‡§®‡§æ</div>
        </div>
        <div class="algorithm">
          <strong>Metadata Cleanup</strong>
          <div>Unnecessary metadata ‡§î‡§∞ properties remove ‡§ï‡§∞‡§®‡§æ</div>
        </div>
      </div>

      <div id="results" class="results"></div>
    </div>

    <!-- Google AdSense Placeholder -->
    <div style="margin:2rem 0;text-align:center;padding:2rem;border:1px dashed var(--border);border-radius:12px;background:rgba(11,132,255,.02)">
      <div style="color:var(--muted);font-style:italic;padding:40px;border:1px dashed var(--border);border-radius:8px;">
        Google AdSense Advertisement Space<br>
        <small>Replace with actual AdSense code</small>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; <span id="year"></span> Office Tools. Advanced PDF Compression Technology.</p>
  </footer>

  <!-- Enhanced PDF Processing Libraries -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  
  <script>
    // Theme functionality
    (function(){
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const saved = localStorage.getItem('theme');
      const initial = saved || (prefersDark ? 'dark' : 'light');
      const root = document.documentElement;
      const btn = document.getElementById('modeToggle');
      
      function apply(theme){
        root.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        btn.textContent = theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
      }
      apply(initial);
      btn.addEventListener('click', () => {
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        apply(next);
      });
      document.getElementById('year').textContent = new Date().getFullYear();
    })();

    // Elements
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const compressionLevel = document.getElementById('compressionLevel');
    const imageQuality = document.getElementById('imageQuality');
    const imgQVal = document.getElementById('imgQVal');
    const targetSizeMB = document.getElementById('targetSizeMB');
    const removeMetadata = document.getElementById('removeMetadata');
    const results = document.getElementById('results');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const compressBtn = document.getElementById('compressBtn');
    const clearBtn = document.getElementById('clearBtn');

    // Update displays
    imgQVal.textContent = imageQuality.value;
    imageQuality.addEventListener('input', () => imgQVal.textContent = imageQuality.value);

    // File handling
    let selectedFiles = [];

    function highlight(on) { drop.classList.toggle('drag', !!on); }
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();highlight(true);}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();highlight(false);}));

    drop.addEventListener('drop', e => {
      const files = Array.from(e.dataTransfer.files).filter(f => 
        f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')
      );
      if (files.length) handleFiles(files);
    });

    browseBtn.addEventListener('click', () => {
      fileInput.value = '';
      fileInput.click();
    });

    fileInput.addEventListener('change', e => {
      if (e.target.files && e.target.files.length) {
        const files = Array.from(e.target.files).filter(f => 
          f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf')
        );
        handleFiles(files);
      }
    });

    function handleFiles(files) {
      if (!files.length) {
        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡•à‡§ß PDF ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§ö‡•Å‡§®‡•á‡§Ç‡•§');
        return;
      }
      
      selectedFiles = [...selectedFiles, ...files.map(file => ({ 
        file, 
        originalSize: file.size,
        compressedSize: null,
        compressionRatio: null,
        status: 'ready',
        analysis: null,
        compressedBlob: null
      }))];
      
      updateUI();
      analyzeBtn.disabled = false;
      compressBtn.disabled = false;
      clearBtn.disabled = false;
    }

    function updateUI() {
      results.innerHTML = '';
      
      selectedFiles.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        
        const originalMB = (item.originalSize / 1024 / 1024).toFixed(2);
        const compressedMB = item.compressedSize ? (item.compressedSize / 1024 / 1024).toFixed(2) : '---';
        const reductionPercent = item.compressionRatio ? Math.round((1 - item.compressionRatio) * 100) : 0;
        
        div.innerHTML = `
          <div class="file-info">
            <h4>${item.file.name}</h4>
            <div class="file-meta">Original Size: ${originalMB} MB</div>
            <div class="file-meta">Compressed Size: ${compressedMB} MB</div>
            ${item.analysis ? `<div class="file-meta">Analysis: ${item.analysis}</div>` : ''}
            <div class="compression-stats">
              <div class="stat">
                <strong>${reductionPercent}%</strong><br>
                <small>Size Reduction</small>
              </div>
              <div class="stat">
                <strong>${compressedMB}</strong><br>
                <small>Final Size (MB)</small>
              </div>
            </div>
          </div>
          <div class="file-actions">
            <div class="progress" id="progress-${index}"></div>
            <div class="status" id="status-${index}">${item.status === 'ready' ? '‡§§‡•à‡§Ø‡§æ‡§∞' : item.status}</div>
            <a class="download" id="download-${index}">Download</a>
            <button class="secondary" onclick="removeFile(${index})" style="padding:.4rem .6rem;font-size:.8rem;margin-top:6px">Remove</button>
          </div>
        `;
        results.appendChild(div);

        // Store references
        item.progressEl = document.getElementById(`progress-${index}`);
        item.statusEl = document.getElementById(`status-${index}`);
        item.downloadEl = document.getElementById(`download-${index}`);
      });
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateUI();
      if (selectedFiles.length === 0) {
        analyzeBtn.disabled = true;
        compressBtn.disabled = true;
        clearBtn.disabled = true;
      }
    }

    clearBtn.addEventListener('click', () => {
      selectedFiles = [];
      results.innerHTML = '';
      analyzeBtn.disabled = true;
      compressBtn.disabled = true;
      clearBtn.disabled = true;
    });

    // Advanced PDF Analysis
    analyzeBtn.addEventListener('click', async () => {
      if (!selectedFiles.length) return;
      
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = 'Analyzing...';
      
      for (let i = 0; i < selectedFiles.length; i++) {
        const item = selectedFiles[i];
        item.progressEl.style.display = 'block';
        item.statusEl.textContent = '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
        item.statusEl.className = 'status processing';
        
        try {
          const arrayBuffer = await item.file.arrayBuffer();
          const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
          
          const pageCount = pdfDoc.getPageCount();
          const hasImages = await detectImages(arrayBuffer);
          const metadataSize = await estimateMetadataSize(pdfDoc);
          
          let analysis = `${pageCount} pages`;
          if (hasImages) analysis += ', Images detected';
          if (metadataSize > 1024) analysis += ', Heavy metadata';
          
          item.analysis = analysis;
          item.statusEl.textContent = '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£';
          item.statusEl.className = 'status success';
          
        } catch (error) {
          console.error('Analysis failed:', error);
          item.statusEl.textContent = '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§Ö‡§∏‡§´‡§≤';
          item.statusEl.className = 'status error';
          item.analysis = 'Analysis failed';
        } finally {
          item.progressEl.style.display = 'none';
        }
      }
      
      updateUI();
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = 'Analyze PDFs';
    });

    // Enhanced PDF Compression with multiple techniques
    compressBtn.addEventListener('click', async () => {
      if (!selectedFiles.length) return;
      
      compressBtn.disabled = true;
      compressBtn.textContent = 'üóúÔ∏è Compressing...';
      
      for (let i = 0; i < selectedFiles.length; i++) {
        await compressPDFAdvanced(selectedFiles[i], i);
      }
      
      compressBtn.disabled = false;
      compressBtn.textContent = 'üóúÔ∏è Compress All';
    });

    async function compressPDFAdvanced(item, index) {
      item.progressEl.style.display = 'block';
      item.statusEl.textContent = '‡§ï‡§Ç‡§™‡•ç‡§∞‡•á‡§∂‡§® ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
      item.statusEl.className = 'status processing';
      
      try {
        const arrayBuffer = await item.file.arrayBuffer();
        let pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        
        // Step 1: Remove metadata if requested
        if (removeMetadata.checked) {
          pdfDoc = await removeMetadataAndCleanup(pdfDoc);
        }
        
        // Step 2: Apply compression based on level
        const level = compressionLevel.value;
        let compressionOptions = getCompressionOptions(level);
        
        // Step 3: Apply target size if specified
        const targetSize = parseFloat(targetSizeMB.value);
        let compressedBytes;
        
        if (targetSize > 0) {
          compressedBytes = await compressToTargetSize(pdfDoc, targetSize, compressionOptions);
        } else {
          compressedBytes = await pdfDoc.save(compressionOptions);
        }
        
        // Step 4: Create download
        const compressedSize = compressedBytes.length;
        const compressionRatio = compressedSize / item.originalSize;
        
        if (compressionRatio >= 0.95) {
          // If compression is less than 5%, show warning
          item.statusEl.textContent = '‡§ï‡§Æ ‡§ï‡§Ç‡§™‡•ç‡§∞‡•á‡§∂‡§® (< 5%)';
          item.statusEl.className = 'status warning';
          item.analysis = (item.analysis || '') + ' - Already optimized';
        } else {
          item.statusEl.textContent = `${Math.round((1-compressionRatio)*100)}% ‡§ï‡§Æ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ`;
          item.statusEl.className = 'status success';
        }
        
        const blob = new Blob([compressedBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        item.downloadEl.href = url;
        item.downloadEl.download = `compressed_${item.file.name}`;
        item.downloadEl.style.display = 'inline-block';
        
        item.compressedSize = compressedSize;
        item.compressionRatio = compressionRatio;
        item.compressedBlob = blob;
        
      } catch (error) {
        console.error('Compression failed:', error);
        item.statusEl.textContent = '‡§ï‡§Ç‡§™‡•ç‡§∞‡•á‡§∂‡§® ‡§Ö‡§∏‡§´‡§≤';
        item.statusEl.className = 'status error';
        
        // Fallback: try basic compression
        try {
          const basicBytes = await PDFLib.PDFDocument.load(await item.file.arrayBuffer()).then(doc => 
            doc.save({ compress: true })
          );
          
          if (basicBytes.length < item.originalSize) {
            const blob = new Blob([basicBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            
            item.downloadEl.href = url;
            item.downloadEl.download = `basic_compressed_${item.file.name}`;
            item.downloadEl.style.display = 'inline-block';
            
            item.compressedSize = basicBytes.length;
            item.compressionRatio = basicBytes.length / item.originalSize;
            
            item.statusEl.textContent = `Basic: ${Math.round((1-item.compressionRatio)*100)}% ‡§ï‡§Æ`;
            item.statusEl.className = 'status success';
          }
        } catch (basicError) {
          console.error('Basic compression also failed:', basicError);
        }
        
      } finally {
        item.progressEl.style.display = 'none';
      }
    }

    // Helper functions
    function getCompressionOptions(level) {
      const options = {
        compress: true,
        addDefaultPage: false
      };
      
      switch(level) {
        case 'light':
          options.objectsPerTick = 50;
          break;
        case 'medium':
          options.objectsPerTick = 200;
          break;
        case 'strong':
          options.objectsPerTick = 500;
          break;
        case 'maximum':
          options.objectsPerTick = 1000;
          break;
      }
      
      return options;
    }

    async function removeMetadataAndCleanup(pdfDoc) {
      try {
        // Remove metadata
        pdfDoc.setTitle('');
        pdfDoc.setAuthor('');
        pdfDoc.setSubject('');
        pdfDoc.setCreator('');
        pdfDoc.setProducer('');
        pdfDoc.setCreationDate(new Date(0));
        pdfDoc.setModificationDate(new Date(0));
        
        return pdfDoc;
      } catch (error) {
        console.warn('Metadata removal failed:', error);
        return pdfDoc;
      }
    }

    async function compressToTargetSize(pdfDoc, targetSizeMB, baseOptions) {
      const targetBytes = targetSizeMB * 1024 * 1024;
      let bestResult = null;
      let low = 50, high = 1000;
      
      for (let i = 0; i < 10; i++) {
        const mid = Math.floor((low + high) / 2);
        const testOptions = { ...baseOptions, objectsPerTick: mid };
        
        try {
          const testBytes = await pdfDoc.save(testOptions);
          bestResult = testBytes;
          
          if (testBytes.length > targetBytes) {
            high = mid;
          } else {
            low = mid;
          }
        } catch (error) {
          high = mid;
        }
      }
      
      return bestResult || await pdfDoc.save(baseOptions);
    }

    async function detectImages(arrayBuffer) {
      try {
        const text = new TextDecoder().decode(arrayBuffer.slice(0, Math.min(10000, arrayBuffer.byteLength)));
        return text.includes('/Image') || text.includes('/DCTDecode') || text.includes('JFIF');
      } catch {
        return false;
      }
    }

    async function estimateMetadataSize(pdfDoc) {
      try {
        const info = [
          pdfDoc.getTitle(),
          pdfDoc.getAuthor(),
          pdfDoc.getSubject(),
          pdfDoc.getCreator(),
          pdfDoc.getProducer()
        ].join('').length;
        return info;
      } catch {
        return 0;
      }
    }

    // Feature detection
    if (!window.FileReader || typeof PDFLib === 'undefined') {
      const warning = document.createElement('div');
      warning.className = 'warning-box';
      warning.innerHTML = '‚ö†Ô∏è ‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ PDF compression ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∞‡•Ç‡§™ ‡§∏‡•á support ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ latest Chrome, Firefox, ‡§Ø‡§æ Safari ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§';
      document.querySelector('.card').insertBefore(warning, drop);
    }
  </script>
</body>

</html>
